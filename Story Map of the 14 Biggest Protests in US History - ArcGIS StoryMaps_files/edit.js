(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{"3QOR":function(t,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/stories/edit",function(){return n("jKCB")}])},Wkul:function(t,e,n){"use strict";var r=n("9fIP"),i=n("MMYH"),o=n("pWxA"),a=n("K/z8"),s=n("sRHE"),c=n("8K1b"),u=n("zjfJ"),l=n("ERkP");function d(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var p=function(t){Object(c.a)(l,t);var e,n=(e=l,function(){var t,n=Object(s.a)(e);if(d()){var r=Object(s.a)(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return Object(a.a)(this,t)});function l(){var t;Object(r.a)(this,l);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return t=n.call.apply(n,[this].concat(i)),Object(u.a)(Object(o.a)(t),"onKeyDownHandler",(function(e){var n=[].concat(t.props.triggerKey),r=t.props.isCtrl&&e.ctrlKey,i=t.props.isMeta&&e.metaKey,o=!t.props.isCtrl&&!t.props.isMeta&&!e.metaKey&&!e.ctrlKey;(r||i||o)&&n.includes(e.key)&&(t.props.on(e),t.props.once&&document.removeEventListener("keydown",t.onKeyDownHandler))})),t}return Object(i.a)(l,[{key:"render",value:function(){return null}},{key:"componentDidMount",value:function(){"undefined"!==typeof document&&document.addEventListener("keydown",this.onKeyDownHandler)}},{key:"componentWillUnmount",value:function(){"undefined"!==typeof document&&document.removeEventListener("keydown",this.onKeyDownHandler)}}]),l}(l.PureComponent);Object(u.a)(p,"defaultProps",{isCtrl:!1,isMeta:!1}),e.a=p},jKCB:function(t,e,n){"use strict";n.r(e);var r=n("VtSi"),i=n.n(r),o=n("9fIP"),a=n("pWxA"),s=n("MMYH"),c=n("K/z8"),u=n("sRHE"),l=n("8K1b"),d=n("zjfJ"),p=n("ERkP"),h=n.n(p),b=n("7xIC"),f=n.n(b),y=n("AU4o"),S=n.n(y),g=n("9Y0E"),m=n("BVlg"),v=n("72yd"),j=n("JmSK"),O=n("8Y5g"),P=n("HxEB"),D=n("itnt"),E=n("mjBc"),w=n("Wkul"),I=n("PxFk"),U=n("ZcpU"),R=n("fQV3"),C=n("EP0r"),k=n("2SGB"),_=n("79uv"),K=n("txt0"),L=n("lU4A"),A=n("7Ez9"),x=n("WMue"),M=n("MHYw"),B=n("7c6K"),F=n("L28g"),N=h.a.createElement;function T(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var H=function(){return N(I.a,{message:N(k.a,{id:"page.edit.loading"})})},z=S()((function(){return Promise.all([n.e(0),n.e(1),n.e(16),n.e(69)]).then(n.bind(null,"Iny9"))}),{loading:H,ssr:!1,loadableGenerated:{webpack:function(){return["Iny9"]},modules:["../../components/StoryEditor"]}}),q=S()((function(){return n.e(24).then(n.bind(null,"wre/"))}),{loading:H,ssr:!1,loadableGenerated:{webpack:function(){return["wre/"]},modules:["../../components/FullPageError"]}}),W=function(t){Object(l.a)(r,t);var e,n=(e=r,function(){var t,n=Object(u.a)(e);if(T()){var r=Object(u.a)(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return Object(c.a)(this,t)});function r(t){var e,s;return Object(o.a)(this,r),s=n.call(this,t),Object(d.a)(Object(a.a)(s),"componentDidMount",(function(){var t;return i.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:(null===(t=s.props.query)||void 0===t?void 0:t.duplicatePhase)&&f.a.replace("/stories/edit?id=".concat(s.props.id),"".concat(s.props.config.BASE_URL,"/stories/").concat(s.props.id,"/edit"),{shallow:!0}),Object(B.a)({url:s.props.config.ARCGIS_JS_API_URL,locale:s.props.locale}),s.initializeStoryItem(),s.fetchStoryData(),window.addEventListener("beforeprint",s.onMenuPrint);case 5:case"end":return e.stop()}}),null,null,null,Promise)})),Object(d.a)(Object(a.a)(s),"initializeStoryItem",(function(){var t;s.storyItem=new g.a({type:m.a.Story,userSession:s.props.userSession,version:"draft",storyMapUserPrivileges:s.props.storyMapUserPrivileges,viewerMode:"builder",config:s.props.config}),s.storyItem.itemId=s.props.id||(null===(t=s.props.query)||void 0===t?void 0:t.id),s.storyItem.on("story-save-start",(function(){s.setState({isSaving:!0})})),s.storyItem.on("story-save-end",(function(){s.setState({isSaving:!1})}))})),Object(d.a)(Object(a.a)(s),"fetchStoryData",(function(){return i.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,i.a.awrap(s.storyItem.fetchStoryBuilderData());case 3:Object(_.f)(s.storyItem.itemDetails)&&s.onDuplicateStoryDetected(),s.setState({isStoryDataLoaded:!0}),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0),t.t0 instanceof Error&&t.t0.message===v.b?Object(C.b)({href:"/error?errType=story-privileges-edit",asPath:"".concat(s.props.config.BASE_URL,"/error?errType=story-privileges-edit")}):s.setState({fetchError:t.t0});case 10:case"end":return t.stop()}}),null,null,[[0,7]],Promise)})),Object(d.a)(Object(a.a)(s),"onPublishStart",(function(t){s.onPublishOrShareStart(t),s.setState({isPublishing:!0})})),Object(d.a)(Object(a.a)(s),"onShareStart",(function(t){s.onPublishOrShareStart(t),s.setState({isSharing:!0})})),Object(d.a)(Object(a.a)(s),"onPublishOrShareStart",(function(t){t&&"string"===typeof t.access&&(s.storyItem.itemSharingLevel=t),s.storyItem.getItemPublishStatus()!==j.c.draft&&Object(U.c)("".concat(s.props.config.BASE_URL,"/stories/").concat(s.storyItem.itemId,"/invalidate"),{httpMethod:"POST"})})),Object(d.a)(Object(a.a)(s),"onPublishAndShareClose",(function(){s.setState({isPublishing:!1,isSharing:!1})})),Object(d.a)(Object(a.a)(s),"onPublishAndShareFinish",(function(){var t;return i.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:s.state.isPublishing?(window.scrollTo(0,0),t="/stories/view?id=".concat(s.storyItem.itemId),f.a.push(t,"".concat(s.props.config.BASE_URL,"/stories/").concat(s.storyItem.itemId))):s.onPublishAndShareClose();case 1:case"end":return e.stop()}}),null,null,null,Promise)})),Object(d.a)(Object(a.a)(s),"onStoryRendered",(function(){s.setState({isStoryRendered:!0})})),Object(d.a)(Object(a.a)(s),"onDuplicateStart",(function(){s.setState({duplicatePhase:"duplicate"})})),Object(d.a)(Object(a.a)(s),"onDuplicateEnd",(function(){s.setState({isDuplicateNudgeShowing:!0,duplicatePhase:void 0})})),Object(d.a)(Object(a.a)(s),"onDuplicateStoryDetected",(function(){s.setState({isDuplicateNudgeShowing:!0,duplicatePhase:"cleanup"})})),Object(d.a)(Object(a.a)(s),"onDuplicateNudgeClose",(function(){s.setState({isDuplicateNudgeShowing:!1})})),Object(d.a)(Object(a.a)(s),"onDiscardUnpublishedStart",(function(){s.setState({isStoryDataLoaded:!1,isDiscardingUnpublishedChanges:!0})})),Object(d.a)(Object(a.a)(s),"onDiscardUnpublishedEnd",(function(){s.setState({isDiscardingUnpublishedChanges:!1})})),Object(d.a)(Object(a.a)(s),"onDiscardUnpublishedError",(function(){s.setState({isStoryDataLoaded:!0,isDiscardingUnpublishedChanges:!1})})),Object(d.a)(Object(a.a)(s),"onUnpublishStart",(function(){Object(U.c)("".concat(s.props.config.BASE_URL,"/stories/").concat(s.storyItem.itemId,"/invalidate"),{httpMethod:"POST"}),s.setState({isUnpublishingStory:!0})})),Object(d.a)(Object(a.a)(s),"onUnpublishEnd",(function(){s.setState({isUnpublishingStory:!1})})),Object(d.a)(Object(a.a)(s),"cancelKeyDown",(function(t){return t.preventDefault()})),Object(d.a)(Object(a.a)(s),"onMenuPrint",(function(t){K.a.trackEvent(K.a.Category.Builder,K.a.Action.Builder_Print_Preview,K.a.Name.From_Browser_Menu),s.onKeyboardPrint()})),Object(d.a)(Object(a.a)(s),"onKeyboardPrint",(function(t){t&&(t.preventDefault(),K.a.trackEvent(K.a.Category.Builder,K.a.Action.Builder_Print_Preview,K.a.Name.From_Keyboard));var e=s.storyItem.itemDetails.id;Object(C.b)({href:"/stories/preview?id=".concat(e,"&printMode=basic-print&mode=fullscreen-preview"),asPath:"".concat(s.props.config.BASE_URL,"/stories/").concat(e,"/edit/print")})})),s.state={isSaving:!1,isPublishing:!1,isSharing:!1,duplicatePhase:null===(e=s.props.query)||void 0===e?void 0:e.duplicatePhase,isDuplicateNudgeShowing:!1,isStoryDataLoaded:!1,isStoryRendered:!1,isDiscardingUnpublishedChanges:!1,isUnpublishingStory:!1},s}return Object(s.a)(r,null,[{key:"getInitialProps",value:function(t,e){var n,r,o,a;return i.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(n=t.query.id,r=e.config,o=e.locale,"string"===typeof n){s.next=5;break}return Object(M.d)({ctx:t,signInUrl:e.signInUrl,config:r}),s.abrupt("return",{});case 5:return s.prev=5,s.next=8,i.a.awrap(Object(R.a)(n,{authentication:e.userSession}));case 8:if("update"===(a=s.sent).itemControl||"admin"===a.itemControl){s.next=12;break}return Object(C.b)({ctx:t,href:"/error?errType=story-privileges-edit",asPath:"".concat(r.BASE_URL,"/error?errType=story-privileges-edit")}),s.abrupt("return",{});case 12:s.next=18;break;case 14:return s.prev=14,s.t0=s.catch(5),Object(M.d)({ctx:t,userSession:e.userSession,signInUrl:e.signInUrl,error:s.t0,config:r}),s.abrupt("return",{});case 18:return s.abrupt("return",{config:r,locale:o,id:n,key:"".concat(n).concat(t.query.duplicatePhase||"noDup")});case 19:case"end":return s.stop()}}),null,null,[[5,14]],Promise)}}]),Object(s.a)(r,[{key:"componentWillUnmount",value:function(){window.removeEventListener("beforeprint",this.onMenuPrint)}},{key:"render",value:function(){var t;return N(O.a,null,N(P.a,null,this.state.fetchError&&this.state.fetchError.recoveryData?N(q,{description:N(k.a,{id:"page.stories.errorRecovery",values:{GeoNet:N("a",{href:"https://community.esri.com/community/arcgis-storymaps/blog/2019/09/24/known-issue-the-story-builder-cannot-be-loaded",rel:"noopener noreferrer",target:"_blank"},N(k.a,{id:"common.geonet"}))}}),linkText:N(k.a,{id:"page.stories.errorRecovery.downloadButton"}),link:{href:this.state.fetchError.recoveryData,download:"StoryMap_Draft_Recovery_".concat(this.state.fetchError.itemId,".json")}}):this.state.fetchError?N(q,{description:N(k.a,{id:"page.stories.errorUnloaded"}),detailedError:this.state.fetchError}):N(D.a,null),this.state.isStoryDataLoaded&&N(E.a,{areLabFeaturesEnabled:this.props.config.ENABLE_LAB_FEATURES&&"true"===(null===(t=this.props.query)||void 0===t?void 0:t.areLabFeaturesEnabled)},N(z,{origin:this.props.origin,isSaving:this.state.isSaving,storyItem:this.storyItem,signInUrl:this.props.signInUrl,onStoryRendered:this.onStoryRendered,onPublish:this.onPublishStart,onShareStory:this.onShareStart,onDuplicateStoryClicked:this.onDuplicateStart,isDuplicateNudgeShowing:this.state.isDuplicateNudgeShowing,onDuplicateNudgeClose:this.onDuplicateNudgeClose,onDiscardUnpublishedClicked:this.onDiscardUnpublishedStart,onUnpublishClicked:this.onUnpublishStart}),N(w.a,{triggerKey:["p","z"],isCtrl:!0,isMeta:!0,on:this.cancelKeyDown}),N(w.a,{triggerKey:"y",isCtrl:!0,on:this.cancelKeyDown}),N(w.a,{triggerKey:"p",isCtrl:!0,isMeta:!0,on:this.onKeyboardPrint})),(this.state.isPublishing||this.state.isSharing)&&N(L.a,{onFinish:this.onPublishAndShareFinish,onClose:this.onPublishAndShareClose,storyItem:this.storyItem,mode:this.state.isPublishing?"publishing":"sharing",itemType:m.a.Story}),this.state.duplicatePhase&&N(F.a,{phase:this.state.duplicatePhase,isStoryRendered:this.state.isStoryRendered,storyItem:this.storyItem,onFinish:this.onDuplicateEnd,onClose:this.onDuplicateEnd,itemType:m.a.Story}),this.state.isDiscardingUnpublishedChanges&&N(A.a,{fetchStoryData:this.fetchStoryData,storyItem:this.storyItem,onFinish:this.onDiscardUnpublishedEnd,onClose:this.onDiscardUnpublishedError,itemType:m.a.Story}),this.state.isUnpublishingStory&&N(x.a,{storyItem:this.storyItem,onFinish:this.onUnpublishEnd,onClose:this.onUnpublishEnd,itemType:m.a.Story})))}}]),r}(p.Component);Object(d.a)(W,"requiresAuthentication",!0),e.default=W},mjBc:function(t,e,n){"use strict";n.d(e,"a",(function(){return s})),n.d(e,"b",(function(){return c}));var r=n("cxan"),i=n("ERkP"),o=n.n(i).a.createElement,a=Object(i.createContext)({areLabFeaturesEnabled:!1}),s=function(t){var e=t.children,n=t.areLabFeaturesEnabled;return o(a.Provider,{value:{areLabFeaturesEnabled:n}},e)},c=function(t){return function(e){return o(a.Consumer,null,(function(n){return o(t,Object(r.a)({},e,n))}))}}}},[["3QOR",3,2,0,4,5,6,8,9,10,11,13,17,20]]]);